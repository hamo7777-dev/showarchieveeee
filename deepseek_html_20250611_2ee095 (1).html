<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Archive System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .login-container h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .login-form .form-group {
            margin-bottom: 20px;
        }
        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .login-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .login-form button:hover {
            background-color: #45a049;
        }
        .error-message {
            color: red;
            margin-top: 10px;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="email"], input[type="tel"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .btn-danger {
            background-color: #f44336;
        }
        .btn-danger:hover {
            background-color: #da190b;
        }
        .btn-clear {
            background-color: #ff9800;
        }
        .btn-clear:hover {
            background-color: #e68900;
        }
        .btn-primary {
            background-color: #2196F3;
        }
        .btn-primary:hover {
            background-color: #0b7dda;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .active {
            color: green;
            font-weight: bold;
        }
        .inactive {
            color: red;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: black;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .image-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 5px;
            border-radius: 4px;
        }
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .search-filter-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .search-group {
            flex: 1;
            min-width: 200px;
        }
        .search-group label {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .search-group input, .search-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .results-info {
            margin: 10px 0;
            padding: 10px;
            background-color: #e7f3ff;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        .nav-container {
            background-color: #2c3e50;
            padding: 15px 0;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
        }
        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        .nav-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        .nav-stats {
            display: flex;
            gap: 20px;
            color: white;
        }
        .nav-stat {
            text-align: center;
        }
        .nav-stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }
        .nav-stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        .product-count {
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }
        .audit-log {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        .audit-log h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .audit-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .audit-entry:last-child {
            border-bottom: none;
        }
        .audit-user {
            font-weight: bold;
            color: #2c3e50;
        }
        .audit-date {
            color: #7f8c8d;
            font-size: 12px;
        }
        .audit-action {
            color: #27ae60;
        }
        .report-filters {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .report-options {
            margin-top: 15px;
        }
        .report-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .user-info {
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        .logout-btn {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        .approval-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        .approval-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .approval-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .approval-details {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .changes-list {
            margin-top: 5px;
            padding-left: 20px;
        }
        .change-item {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="login-section" class="login-container">
        <h1>Product Archive System</h1>
        <form class="login-form" id="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">Login</button>
            <div id="login-error" class="error-message"></div>
        </form>
    </div>

    <!-- Main System Container -->
    <div id="main-system" class="container">
        <div class="nav-container">
            <div class="nav-content">
                <div class="nav-title">Product Archive System</div>
                <div class="nav-stats">
                    <div class="nav-stat">
                        <div class="nav-stat-number" id="total-companies">0</div>
                        <div class="nav-stat-label">Companies</div>
                    </div>
                    <div class="nav-stat">
                        <div class="nav-stat-number" id="total-products">0</div>
                        <div class="nav-stat-label">Products</div>
                    </div>
                    <div class="nav-stat">
                        <div class="nav-stat-number" id="active-products">0</div>
                        <div class="nav-stat-label">Active Products</div>
                    </div>
                    <div class="user-info">
                        <span id="logged-in-user"></span>
                        <button class="logout-btn" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'companies')">Companies</button>
            <button class="tablinks" onclick="openTab(event, 'products')">Products</button>
            <button class="tablinks" onclick="openTab(event, 'add_company')">Add Company</button>
            <button class="tablinks" onclick="openTab(event, 'add_product')">Add Product</button>
            <button class="tablinks" onclick="openTab(event, 'reports')">Reports</button>
            <button class="tablinks" id="approvals-tab" onclick="openTab(event, 'approvals')" style="display:none;">Pending Approvals <span id="approval-count" class="product-count">0</span></button>
        </div>
        
        <div id="companies" class="tabcontent" style="display: block;">
            <h2>Company List</h2>
            
            <div class="search-filter-container">
                <div class="search-row">
                    <div class="search-group">
                        <label for="company-search">Search Company Name</label>
                        <input type="text" id="company-search" placeholder="Enter company name...">
                    </div>
                    <div class="search-group">
                        <label for="contact-search">Search Contact Person</label>
                        <input type="text" id="contact-search" placeholder="Enter contact person name...">
                    </div>
                    <div class="search-group">
                        <label for="city-filter">City Filter</label>
                        <select id="city-filter">
                            <option value="">All Cities</option>
                        </select>
                    </div>
                </div>
                <div class="filter-buttons">
                    <button onclick="filterCompanies()">Filter</button>
                    <button class="btn-clear" onclick="clearCompanyFilters()">Clear</button>
                </div>
            </div>
            
            <div class="results-info" id="company-results-info"></div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Company Name</th>
                        <th>Contact Person</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Address</th>
                        <th>Products</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="companies-table-body">
                </tbody>
            </table>
        </div>
        
        <div id="products" class="tabcontent">
            <h2>Product List</h2>
            
            <div class="search-filter-container">
                <div class="search-row">
                    <div class="search-group">
                        <label for="product-search">Search Product Name</label>
                        <input type="text" id="product-search" placeholder="Enter product name...">
                    </div>
                    <div class="search-group">
                        <label for="company-filter">Company Filter</label>
                        <select id="company-filter">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="status-filter">Status Filter</label>
                        <select id="status-filter">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="search-row">
                    <div class="search-group">
                        <label for="min-price">Min Price (IQD)</label>
                        <input type="number" id="min-price" placeholder="0" min="0">
                    </div>
                    <div class="search-group">
                        <label for="max-price">Max Price (IQD)</label>
                        <input type="number" id="max-price" placeholder="999999" min="0">
                    </div>
                    <div class="search-group">
                        <label for="representative-search">Search Representative</label>
                        <input type="text" id="representative-search" placeholder="Enter representative name...">
                    </div>
                </div>
                <div class="filter-buttons">
                    <button onclick="filterProducts()">Filter</button>
                    <button class="btn-clear" onclick="clearProductFilters()">Clear</button>
                </div>
            </div>
            
            <div class="results-info" id="product-results-info"></div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Product Name</th>
                        <th>Company</th>
                        <th>Status</th>
                        <th>Representative</th>
                        <th>Cost</th>
                        <th>Profit Margin</th>
                        <th>Sale Price</th>
                        <th>Competitor Prices</th>
                        <th>Images</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table-body">
                </tbody>
            </table>
        </div>
        
        <div id="add_company" class="tabcontent">
            <h2>Add New Company</h2>
            <form id="company-form">
                <div class="form-group">
                    <label for="company_name">Company Name*</label>
                    <input type="text" id="company_name" name="company_name" required>
                </div>
                
                <div class="form-group">
                    <label for="contact_person">Contact Person</label>
                    <input type="text" id="contact_person" name="contact_person">
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone" name="phone">
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
                
                <div class="form-group">
                    <label for="address">Address</label>
                    <textarea id="address" name="address" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" rows="3"></textarea>
                </div>
                
                <button type="submit">Save Company</button>
            </form>
        </div>
        
        <div id="add_product" class="tabcontent">
            <h2>Add New Product</h2>
            <form id="product-form">
                <div class="form-group">
                    <label for="product_company_id">Company*</label>
                    <select id="product_company_id" name="company_id" required>
                        <option value="">-- Select Company --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="product_name">Product Name*</label>
                    <input type="text" id="product_name" name="product_name" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is_active" name="is_active" checked> Active Product
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="representative_name">Representative Name</label>
                    <input type="text" id="representative_name" name="representative_name">
                </div>
                
                <div class="form-group">
                    <label for="representative_phone">Representative Phone</label>
                    <input type="tel" id="representative_phone" name="representative_phone">
                </div>
                
                <div class="form-group">
                    <label for="cost_price">Cost Price (IQD)*</label>
                    <input type="number" id="cost_price" name="cost_price" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="sale_price">Sale Price (IQD)*</label>
                    <input type="number" id="sale_price" name="sale_price" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label>Profit Calculation</label>
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label for="profit_amount">Profit Amount (IQD)</label>
                            <input type="text" id="profit_amount" readonly style="background-color: #f0f0f0;">
                        </div>
                        <div style="flex: 1;">
                            <label for="profit_margin_display">Profit Margin (%)</label>
                            <input type="text" id="profit_margin_display" readonly style="background-color: #f0f0f0;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="competitor_prices">Competitor Prices (You can write like: Market A: 1500 IQD, Market B: 1600 IQD)</label>
                    <textarea id="competitor_prices" name="competitor_prices" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="product_images">Product Images</label>
                    <input type="file" id="product_images" name="product_images" multiple accept="image/*">
                    <div id="image-preview" class="image-preview"></div>
                </div>
                
                <button type="submit">Save Product</button>
            </form>
        </div>
        
        <div id="reports" class="tabcontent">
            <h2>Reports</h2>
            
            <div class="report-filters">
                <h3>Filter Options</h3>
                
                <div class="search-row">
                    <div class="search-group">
                        <label for="report-company">Company</label>
                        <select id="report-company">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="report-status">Status</label>
                        <select id="report-status">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="report-date-from">Date From</label>
                        <input type="date" id="report-date-from">
                    </div>
                    <div class="search-group">
                        <label for="report-date-to">Date To</label>
                        <input type="date" id="report-date-to">
                    </div>
                </div>
                
                <div class="report-options">
                    <h3>Report Options</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="include-cost" checked> Include Cost Price
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="include-sale" checked> Include Sale Price
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="include-profit" checked> Include Profit Calculation
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="include-competitors" checked> Include Competitor Prices
                        </label>
                    </div>
                </div>
                
                <div class="report-actions">
                    <button class="btn-primary" onclick="generateReport()">Generate Report</button>
                    <button class="btn-clear" onclick="clearReportFilters()">Clear Filters</button>
                    <button class="btn-danger" onclick="exportToPDF()">Export to PDF</button>
                    <button class="btn-primary" onclick="exportToExcel()">Export to Excel</button>
                </div>
            </div>
            
            <div id="report-results">
                <div class="no-results">Use the filters above to generate a report</div>
            </div>
        </div>
        
        <div id="approvals" class="tabcontent">
            <h2>Pending Approvals</h2>
            <div id="approvals-list">
                <div class="no-results">No pending approvals</div>
            </div>
        </div>
        
        <div id="editProductModal" class="modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px;">
                <span class="close" onclick="closeModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2>Edit Product</h2>
                <form id="edit-product-form">
                    <input type="hidden" id="edit-product-id">
                    <div class="form-group">
                        <label for="edit-product-company">Company*</label>
                        <select id="edit-product-company" name="company_id" required>
                            <option value="">-- Select Company --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-name">Product Name*</label>
                        <input type="text" id="edit-product-name" name="product_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-description">Description</label>
                        <textarea id="edit-product-description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="edit-product-active" name="is_active"> Active Product
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-representative">Representative Name</label>
                        <input type="text" id="edit-product-representative" name="representative_name">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-rep-phone">Representative Phone</label>
                        <input type="tel" id="edit-product-rep-phone" name="representative_phone">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-cost">Cost Price (IQD)*</label>
                        <input type="number" id="edit-product-cost" name="cost_price" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-sale">Sale Price (IQD)*</label>
                        <input type="number" id="edit-product-sale" name="sale_price" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Profit Calculation</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label for="edit-profit-amount">Profit Amount (IQD)</label>
                                <input type="text" id="edit-profit-amount" readonly style="background-color: #f0f0f0;">
                            </div>
                            <div style="flex: 1;">
                                <label for="edit-profit-margin">Profit Margin (%)</label>
                                <input type="text" id="edit-profit-margin" readonly style="background-color: #f0f0f0;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-competitors">Competitor Prices</label>
                        <textarea id="edit-product-competitors" name="competitor_prices" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-product-images">Product Images</label>
                        <input type="file" id="edit-product-images" name="product_images" multiple accept="image/*">
                        <div id="edit-image-preview" class="image-preview"></div>
                    </div>
                    
                    <div class="audit-log">
                        <h3>Change History</h3>
                        <div id="product-audit-log"></div>
                    </div>
                    
                    <div class="actions" style="margin-top: 20px;">
                        <button type="submit">Save Changes</button>
                        <button type="button" class="btn-danger" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // User accounts
        const users = [
            { email: 'ammar@show.com', password: 'ammar123', name: 'Ammar', isAdmin: true },
            { email: 'raveen@show.com', password: 'raveen123', name: 'Raveen', isAdmin: false },
            { email: 'kodo@show.com', password: 'kodo123', name: 'Kodo', isAdmin: false },
            { email: 'haval@show.com', password: 'haval123', name: 'Haval', isAdmin: false },
            { email: 'shvan@show.com', password: 'shvan123', name: 'Shvan', isAdmin: false },
            { email: 'lozan@show.com', password: 'lozan123', name: 'Lozan', isAdmin: false }
        ];
        
        // Current user
        let currentUser = null;
        
        // Data storage
        let companies = [];
        let products = [];
        let nextCompanyId = 1;
        let nextProductId = 1;
        let auditLogs = {};
        let pendingApprovals = [];
        
        // Filtered data
        let filteredCompanies = [];
        let filteredProducts = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Event listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('company-form').addEventListener('submit', addCompany);
            document.getElementById('product-form').addEventListener('submit', addProduct);
            document.getElementById('edit-product-form').addEventListener('submit', updateProduct);
            document.getElementById('cost_price').addEventListener('input', calculateProfitFromCost);
            document.getElementById('sale_price').addEventListener('input', calculateProfitFromSale);
            document.getElementById('edit-product-cost').addEventListener('input', calculateEditProfitFromCost);
            document.getElementById('edit-product-sale').addEventListener('input', calculateEditProfitFromSale);
            document.getElementById('product_images').addEventListener('change', previewImages);
            document.getElementById('edit-product-images').addEventListener('change', previewEditImages);
            
            // Search event listeners
            document.getElementById('company-search').addEventListener('input', filterCompanies);
            document.getElementById('contact-search').addEventListener('input', filterCompanies);
            document.getElementById('product-search').addEventListener('input', filterProducts);
            document.getElementById('representative-search').addEventListener('input', filterProducts);
        });

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('login-error').textContent = '';
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-system').style.display = 'block';
                document.getElementById('logged-in-user').textContent = user.name;
                
                // Show approvals tab ONLY if admin
                if (user.isAdmin) {
                    document.getElementById('approvals-tab').style.display = 'block';
                } else {
                    document.getElementById('approvals-tab').style.display = 'none';
                }
                
                renderCompanies();
                renderProducts();
                updateCompanySelect();
                updateNavStats();
                updateFilterOptions();
                updateReportCompanyOptions();
                updateApprovalsList();
            } else {
                document.getElementById('login-error').textContent = 'Invalid email or password';
            }
        }
        
        function logout() {
            currentUser = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('main-system').style.display = 'none';
            document.getElementById('login-form').reset();
        }

        function saveData() {
            // Using JavaScript variables instead of sessionStorage
            // Data will persist during the session
        }

        function loadData() {
            // Initialize with empty arrays
            companies = [];
            products = [];
            nextCompanyId = 1;
            nextProductId = 1;
            auditLogs = {};
            pendingApprovals = [];
        }
        
        function updateApprovalsList() {
            const approvalsList = document.getElementById('approvals-list');
            
            if (pendingApprovals.length === 0) {
                approvalsList.innerHTML = '<div class="no-results">No pending approvals</div>';
                document.getElementById('approval-count').textContent = '0';
                return;
            }
            
            approvalsList.innerHTML = '';
            document.getElementById('approval-count').textContent = pendingApprovals.length;
            
            pendingApprovals.forEach((approval, index) => {
                const approvalItem = document.createElement('div');
                approvalItem.className = 'approval-item';
                
                const product = products.find(p => p.id === approval.productId);
                const company = companies.find(c => c.id === product.company_id);
                const requester = users.find(u => u.email === approval.requestedBy);
                
                approvalItem.innerHTML = `
                    <div class="approval-header">
                        <span>Approval Request #${index + 1}</span>
                        <span>Requested by: ${requester ? requester.name : approval.requestedBy}</span>
                    </div>
                    <div>Product: ${product ? product.name : 'Unknown'} (ID: ${approval.productId})</div>
                    <div>Company: ${company ? company.name : 'Unknown'}</div>
                    <div class="approval-details">
                        <div>Changes requested:</div>
                        <ul class="changes-list">
                            ${approval.changes.map(change => `<li class="change-item">${change}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="approval-actions">
                        <button onclick="approveChanges(${approval.productId}, ${index})">Approve</button>
                        <button class="btn-danger" onclick="rejectChanges(${approval.productId}, ${index})">Reject</button>
                    </div>
                `;
                
                approvalsList.appendChild(approvalItem);
            });
        }
        
        function approveChanges(productId, approvalIndex) {
            if (!currentUser || !currentUser.isAdmin) {
                alert('Only admin can approve changes.');
                return;
            }
            
            const approval = pendingApprovals[approvalIndex];
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex !== -1) {
                // Apply changes
                products[productIndex] = approval.updatedProduct;
                
                // Add to audit log
                addAuditLog(productId, 'Changes approved by admin', {
                    user: currentUser.name,
                    changes: approval.changes.join(', ')
                });
                
                // Remove from pending approvals
                pendingApprovals.splice(approvalIndex, 1);
                
                // Update UI
                renderProducts();
                updateApprovalsList();
                updateNavStats();
                saveData();
                
                alert('Changes approved successfully');
            }
        }
        
        function rejectChanges(productId, approvalIndex) {
            if (!currentUser || !currentUser.isAdmin) {
                alert('Only admin can reject changes.');
                return;
            }
            
            const approval = pendingApprovals[approvalIndex];
            
            // Add to audit log
            addAuditLog(productId, 'Changes rejected by admin', {
                user: currentUser.name,
                changes: approval.changes.join(', ')
            });
            
            // Remove from pending approvals
            pendingApprovals.splice(approvalIndex, 1);
            
            // Update UI
            updateApprovalsList();
            saveData();
            
            alert('Changes rejected');
        }

        function updateNavStats() {
            document.getElementById('total-companies').textContent = companies.length;
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('active-products').textContent = products.filter(p => p.is_active).length;
        }

        function updateFilterOptions() {
            // Update city filter for companies
            const cities = [...new Set(companies.map(c => c.address).filter(addr => addr))];
            const cityFilter = document.getElementById('city-filter');
            cityFilter.innerHTML = '<option value="">All Cities</option>' +
                cities.map(city => `<option value="${escapeHtml(city)}">${escapeHtml(city)}</option>`).join('');
            
            // Update company filter for products
            const companyFilter = document.getElementById('company-filter');
            companyFilter.innerHTML = '<option value="">All Companies</option>' +
                companies.map(company => `<option value="${company.id}">${escapeHtml(company.name)}</option>`).join('');
        }
        
        function updateReportCompanyOptions() {
            const reportCompany = document.getElementById('report-company');
            reportCompany.innerHTML = '<option value="">All Companies</option>' +
                companies.map(company => `<option value="${company.id}">${escapeHtml(company.name)}</option>`).join('');
        }

        function addCompany(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const formData = new FormData(e.target);
            
            const company = {
                id: nextCompanyId++,
                name: formData.get('company_name'),
                contact_person: formData.get('contact_person'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address'),
                notes: formData.get('notes'),
                created_at: new Date(),
                created_by: currentUser.email
            };

            companies.push(company);
            saveData();
            renderCompanies();
            updateCompanySelect();
            updateNavStats();
            updateFilterOptions();
            updateReportCompanyOptions();
            e.target.reset();
            openTab(event, 'companies');
            
            // Add to audit log
            addAuditLog(null, 'Company created', {
                user: currentUser.name,
                changes: `Created company: ${company.name}`
            });
        }

        function addProduct(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const formData = new FormData(e.target);
            
            const costPrice = parseFloat(formData.get('cost_price')) || 0;
            const salePrice = parseFloat(formData.get('sale_price')) || 0;
            const profitAmount = salePrice - costPrice;
            const profitMargin = costPrice > 0 ? (profitAmount / costPrice) * 100 : 0;

            const product = {
                id: nextProductId++,
                company_id: parseInt(formData.get('company_id')),
                name: formData.get('product_name'),
                description: formData.get('description'),
                is_active: formData.get('is_active') === 'on',
                representative_name: formData.get('representative_name'),
                representative_phone: formData.get('representative_phone'),
                cost_price: costPrice,
                profit_margin: profitMargin,
                profit_amount: profitAmount,
                sale_price: salePrice,
                competitor_prices: formData.get('competitor_prices'),
                images: [],
                created_at: new Date(),
                updated_at: new Date(),
                created_by: currentUser.email
            };

            // Handle images
            const files = document.getElementById('product_images').files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    product.images.push({
                        id: Date.now() + i,
                        name: file.name,
                        data: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            }

            products.push(product);
            
            // Add to audit log
            addAuditLog(product.id, 'Product created', {
                user: currentUser.name,
                changes: 'Initial creation'
            });
            
            saveData();
            renderProducts();
            updateNavStats();
            e.target.reset();
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('profit_amount').value = '';
            document.getElementById('profit_margin_display').value = '';
            openTab(event, 'products');
        }

        function deleteCompany(id) {
            if (!currentUser) return;
            
            if (confirm('Are you sure you want to delete this company?')) {
                const company = companies.find(c => c.id === id);
                
                companies = companies.filter(c => c.id !== id);
                products = products.filter(p => p.company_id !== id);
                saveData();
                renderCompanies();
                renderProducts();
                updateCompanySelect();
                updateNavStats();
                updateFilterOptions();
                updateReportCompanyOptions();
                
                // Add to audit log
                addAuditLog(null, 'Company deleted', {
                    user: currentUser.name,
                    changes: `Deleted company: ${company ? company.name : id}`
                });
            }
        }

        function deleteProduct(id) {
            if (!currentUser) return;
            
            if (confirm('Are you sure you want to delete this product?')) {
                const product = products.find(p => p.id === id);
                
                products = products.filter(p => p.id !== id);
                saveData();
                renderProducts();
                updateNavStats();
                
                // Add to audit log
                addAuditLog(id, 'Product deleted', {
                    user: currentUser.name,
                    changes: `Deleted product: ${product ? product.name : id}`
                });
            }
        }
        
        function editProduct(id) {
            if (!currentUser) return;
            
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-company').value = product.company_id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-description').value = product.description;
            document.getElementById('edit-product-active').checked = product.is_active;
            document.getElementById('edit-product-representative').value = product.representative_name;
            document.getElementById('edit-product-rep-phone').value = product.representative_phone;
            document.getElementById('edit-product-cost').value = product.cost_price;
            document.getElementById('edit-product-sale').value = product.sale_price;
            document.getElementById('edit-profit-amount').value = formatCurrency(product.profit_amount);
            document.getElementById('edit-profit-margin').value = product.profit_margin.toFixed(2);
            document.getElementById('edit-product-competitors').value = product.competitor_prices || '';
            
            // Update company select options
            const companySelect = document.getElementById('edit-product-company');
            companySelect.innerHTML = '<option value="">-- Select Company --</option>' +
                companies.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            companySelect.value = product.company_id;
            
            // Show images
            const imagePreview = document.getElementById('edit-image-preview');
            imagePreview.innerHTML = '';
            if (product.images && product.images.length > 0) {
                product.images.forEach(img => {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = img.data;
                    imgElement.className = 'image-thumbnail';
                    imgElement.style.width = '100px';
                    imgElement.style.height = '100px';
                    
                    const name = document.createElement('span');
                    name.textContent = img.name.length > 15 ? 
                        img.name.substring(0, 12) + '...' : img.name;
                    name.style.fontSize = '12px';
                    
                    div.appendChild(imgElement);
                    div.appendChild(name);
                    imagePreview.appendChild(div);
                });
            }
            
            // Load audit log
            loadAuditLog(id);
            
            // Show modal
            document.getElementById('editProductModal').style.display = 'block';
        }
        
        function updateProduct(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const id = parseInt(document.getElementById('edit-product-id').value);
            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex === -1) return;
            
            const oldProduct = {...products[productIndex]};
            
            const costPrice = parseFloat(document.getElementById('edit-product-cost').value) || 0;
            const salePrice = parseFloat(document.getElementById('edit-product-sale').value) || 0;
            const profitAmount = salePrice - costPrice;
            const profitMargin = costPrice > 0 ? (profitAmount / costPrice) * 100 : 0;
            
            // Get existing images
            const existingImages = products[productIndex].images || [];
            
            // Handle new images
            const newImages = [];
            const files = document.getElementById('edit-product-images').files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    newImages.push({
                        id: Date.now() + i,
                        name: file.name,
                        data: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            }
            
            // Wait for all images to load
            setTimeout(() => {
                const updatedProduct = {
                    ...products[productIndex],
                    company_id: parseInt(document.getElementById('edit-product-company').value),
                    name: document.getElementById('edit-product-name').value,
                    description: document.getElementById('edit-product-description').value,
                    is_active: document.getElementById('edit-product-active').checked,
                    representative_name: document.getElementById('edit-product-representative').value,
                    representative_phone: document.getElementById('edit-product-rep-phone').value,
                    cost_price: costPrice,
                    profit_margin: profitMargin,
                    profit_amount: profitAmount,
                    sale_price: salePrice,
                    competitor_prices: document.getElementById('edit-product-competitors').value,
                    images: [...existingImages, ...newImages],
                    updated_at: new Date(),
                    updated_by: currentUser.email
                };
                
                // Track changes for audit log
                const changes = [];
                if (oldProduct.company_id !== updatedProduct.company_id) {
                    const oldCompany = companies.find(c => c.id === oldProduct.company_id);
                    const newCompany = companies.find(c => c.id === updatedProduct.company_id);
                    changes.push(`Company changed from ${oldCompany ? oldCompany.name : 'None'} to ${newCompany ? newCompany.name : 'None'}`);
                }
                if (oldProduct.name !== updatedProduct.name) {
                    changes.push(`Name changed from "${oldProduct.name}" to "${updatedProduct.name}"`);
                }
                if (oldProduct.is_active !== updatedProduct.is_active) {
                    changes.push(`Status changed to ${updatedProduct.is_active ? 'Active' : 'Inactive'}`);
                }
                if (oldProduct.cost_price !== updatedProduct.cost_price) {
                    changes.push(`Cost price changed from ${formatCurrency(oldProduct.cost_price)} to ${formatCurrency(updatedProduct.cost_price)}`);
                }
                if (oldProduct.sale_price !== updatedProduct.sale_price) {
                    changes.push(`Sale price changed from ${formatCurrency(oldProduct.sale_price)} to ${formatCurrency(updatedProduct.sale_price)}`);
                }
                
                if (currentUser.isAdmin) {
                    // Admin can directly update
                    products[productIndex] = updatedProduct;
                    
                    if (changes.length > 0) {
                        addAuditLog(id, 'Product updated by admin', {
                            user: currentUser.name,
                            changes: changes.join(', ')
                        });
                    }
                    
                    saveData();
                    renderProducts();
                    updateNavStats();
                    closeModal();
                } else {
                    // Regular users need approval
                    const approval = {
                        productId: id,
                        originalProduct: oldProduct,
                        updatedProduct: updatedProduct,
                        changes: changes,
                        requestedBy: currentUser.email,
                        requestedAt: new Date()
                    };
                    
                    pendingApprovals.push(approval);
                    
                    addAuditLog(id, 'Update requested (pending approval)', {
                        user: currentUser.name,
                        changes: changes.join(', ')
                    });
                    
                    saveData();
                    updateApprovalsList();
                    closeModal();
                    
                    alert('Your changes have been submitted for approval by the admin.');
                }
            }, 100);
        }
        
        function loadAuditLog(productId) {
            const logContainer = document.getElementById('product-audit-log');
            logContainer.innerHTML = '';
            
            const logs = auditLogs[productId] || [];
            if (logs.length === 0) {
                logContainer.innerHTML = '<div class="audit-entry">No history found for this product</div>';
                return;
            }
            
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'audit-entry';
                
                const action = document.createElement('div');
                action.innerHTML = `<span class="audit-action">${log.action}</span> by <span class="audit-user">${log.user}</span>`;
                
                const date = document.createElement('div');
                date.className = 'audit-date';
                date.textContent = new Date(log.timestamp).toLocaleString();
                
                const changes = document.createElement('div');
                changes.style.marginTop = '5px';
                changes.textContent = log.changes;
                
                entry.appendChild(action);
                entry.appendChild(date);
                entry.appendChild(changes);
                logContainer.appendChild(entry);
            });
        }
        
        function addAuditLog(productId, action, data) {
            const logKey = productId || 'companies';
            
            if (!auditLogs[logKey]) {
                auditLogs[logKey] = [];
            }
            
            auditLogs[logKey].push({
                timestamp: new Date(),
                action: action,
                user: data.user,
                changes: data.changes
            });
        }

        function closeModal() {
            document.getElementById('editProductModal').style.display = 'none';
        }

        function renderCompanies() {
            const tbody = document.getElementById('companies-table-body');
            tbody.innerHTML = '';
            
            const dataToRender = filteredCompanies.length > 0 ? filteredCompanies : companies;
            
            if (dataToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-results">No companies found</td></tr>';
                return;
            }
            
            dataToRender.forEach(company => {
                const tr = document.createElement('tr');
                
                // Count products for this company
                const productCount = products.filter(p => p.company_id === company.id).length;
                
                tr.innerHTML = `
                    <td>${company.id}</td>
                    <td>${escapeHtml(company.name)}</td>
                    <td>${escapeHtml(company.contact_person || '')}</td>
                    <td>${escapeHtml(company.phone || '')}</td>
                    <td>${escapeHtml(company.email || '')}</td>
                    <td>${escapeHtml(company.address || '')}</td>
                    <td>${productCount}</td>
                    <td>${escapeHtml(company.notes || '').substring(0, 50)}${company.notes && company.notes.length > 50 ? '...' : ''}</td>
                    <td class="actions">
                        <button onclick="editCompany(${company.id})">Edit</button>
                        <button class="btn-danger" onclick="deleteCompany(${company.id})">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Update results info
            const resultsInfo = document.getElementById('company-results-info');
            resultsInfo.textContent = `Showing ${dataToRender.length} of ${companies.length} companies`;
        }

        function renderProducts() {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = '';
            
            const dataToRender = filteredProducts.length > 0 ? filteredProducts : products;
            
            if (dataToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="no-results">No products found</td></tr>';
                return;
            }
            
            dataToRender.forEach(product => {
                const tr = document.createElement('tr');
                
                const company = companies.find(c => c.id === product.company_id);
                const companyName = company ? company.name : 'Unknown';
                
                const statusClass = product.is_active ? 'active' : 'inactive';
                const statusText = product.is_active ? 'Active' : 'Inactive';
                
                // Create image thumbnails
                let imagesHtml = '';
                if (product.images && product.images.length > 0) {
                    const firstThree = product.images.slice(0, 3);
                    imagesHtml = firstThree.map(img => 
                        `<img src="${img.data}" class="image-thumbnail" title="${escapeHtml(img.name)}">`
                    ).join('');
                    
                    if (product.images.length > 3) {
                        imagesHtml += `<span class="product-count">+${product.images.length - 3}</span>`;
                    }
                }
                
                tr.innerHTML = `
                    <td>${product.id}</td>
                    <td>${escapeHtml(product.name)}</td>
                    <td>${escapeHtml(companyName)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${escapeHtml(product.representative_name || '')}</td>
                    <td>${formatCurrency(product.cost_price)} IQD</td>
                    <td>${product.profit_margin.toFixed(2)}%</td>
                    <td>${formatCurrency(product.sale_price)} IQD</td>
                    <td>${escapeHtml(product.competitor_prices || '').substring(0, 30)}${product.competitor_prices && product.competitor_prices.length > 30 ? '...' : ''}</td>
                    <td>${imagesHtml}</td>
                    <td class="actions">
                        <button onclick="editProduct(${product.id})">Edit</button>
                        <button class="btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Update results info
            const resultsInfo = document.getElementById('product-results-info');
            resultsInfo.textContent = `Showing ${dataToRender.length} of ${products.length} products`;
        }

        function updateCompanySelect() {
            const select = document.getElementById('product_company_id');
            select.innerHTML = '<option value="">-- Select Company --</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                select.appendChild(option);
            });
        }

        function calculateProfitFromCost() {
            const cost = parseFloat(document.getElementById('cost_price').value) || 0;
            const sale = parseFloat(document.getElementById('sale_price').value) || 0;
            
            const profit = sale - cost;
            const margin = cost > 0 ? (profit / cost) * 100 : 0;
            
            document.getElementById('profit_amount').value = formatCurrency(profit);
            document.getElementById('profit_margin_display').value = margin.toFixed(2);
        }

        function calculateProfitFromSale() {
            const cost = parseFloat(document.getElementById('cost_price').value) || 0;
            const sale = parseFloat(document.getElementById('sale_price').value) || 0;
            
            const profit = sale - cost;
            const margin = cost > 0 ? (profit / cost) * 100 : 0;
            
            document.getElementById('profit_amount').value = formatCurrency(profit);
            document.getElementById('profit_margin_display').value = margin.toFixed(2);
        }
        
        function calculateEditProfitFromCost() {
            const cost = parseFloat(document.getElementById('edit-product-cost').value) || 0;
            const sale = parseFloat(document.getElementById('edit-product-sale').value) || 0;
            
            const profit = sale - cost;
            const margin = cost > 0 ? (profit / cost) * 100 : 0;
            
            document.getElementById('edit-profit-amount').value = formatCurrency(profit);
            document.getElementById('edit-profit-margin').value = margin.toFixed(2);
        }
        
        function calculateEditProfitFromSale() {
            const cost = parseFloat(document.getElementById('edit-product-cost').value) || 0;
            const sale = parseFloat(document.getElementById('edit-product-sale').value) || 0;
            
            const profit = sale - cost;
            const margin = cost > 0 ? (profit / cost) * 100 : 0;
            
            document.getElementById('edit-profit-amount').value = formatCurrency(profit);
            document.getElementById('edit-profit-margin').value = margin.toFixed(2);
        }

        function previewImages() {
            const files = document.getElementById('product_images').files;
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-thumbnail';
                    img.style.width = '100px';
                    img.style.height = '100px';
                    
                    const name = document.createElement('span');
                    name.textContent = file.name.length > 15 ? 
                        file.name.substring(0, 12) + '...' : file.name;
                    name.style.fontSize = '12px';
                    
                    div.appendChild(img);
                    div.appendChild(name);
                    preview.appendChild(div);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function previewEditImages() {
            const files = document.getElementById('edit-product-images').files;
            const preview = document.getElementById('edit-image-preview');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-thumbnail';
                    img.style.width = '100px';
                    img.style.height = '100px';
                    
                    const name = document.createElement('span');
                    name.textContent = file.name.length > 15 ? 
                        file.name.substring(0, 12) + '...' : file.name;
                    name.style.fontSize = '12px';
                    
                    div.appendChild(img);
                    div.appendChild(name);
                    preview.appendChild(div);
                };
                
                reader.readAsDataURL(file);
            }
        }

        function filterCompanies() {
            const nameSearch = document.getElementById('company-search').value.toLowerCase();
            const contactSearch = document.getElementById('contact-search').value.toLowerCase();
            const cityFilter = document.getElementById('city-filter').value.toLowerCase();
            
            filteredCompanies = companies.filter(company => {
                const nameMatch = company.name.toLowerCase().includes(nameSearch);
                const contactMatch = company.contact_person ? company.contact_person.toLowerCase().includes(contactSearch) : false;
                const cityMatch = cityFilter === '' || (company.address && company.address.toLowerCase().includes(cityFilter));
                
                return nameMatch && contactMatch && cityMatch;
            });
            
            renderCompanies();
        }
        
        function filterProducts() {
            const productSearch = document.getElementById('product-search').value.toLowerCase();
            const companyFilter = document.getElementById('company-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
            const repSearch = document.getElementById('representative-search').value.toLowerCase();
            
            filteredProducts = products.filter(product => {
                const nameMatch = product.name.toLowerCase().includes(productSearch);
                const companyMatch = companyFilter === '' || product.company_id.toString() === companyFilter;
                const statusMatch = statusFilter === '' || 
                    (statusFilter === 'active' && product.is_active) || 
                    (statusFilter === 'inactive' && !product.is_active);
                const priceMatch = product.sale_price >= minPrice && product.sale_price <= maxPrice;
                const repMatch = product.representative_name ? 
                    product.representative_name.toLowerCase().includes(repSearch) : false;
                
                return nameMatch && companyMatch && statusMatch && priceMatch && repMatch;
            });
            
            renderProducts();
        }
        
        function clearCompanyFilters() {
            document.getElementById('company-search').value = '';
            document.getElementById('contact-search').value = '';
            document.getElementById('city-filter').value = '';
            filteredCompanies = [];
            renderCompanies();
        }
        
        function clearProductFilters() {
            document.getElementById('product-search').value = '';
            document.getElementById('company-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            document.getElementById('representative-search').value = '';
            filteredProducts = [];
            renderProducts();
        }
        
        function clearReportFilters() {
            document.getElementById('report-company').value = '';
            document.getElementById('report-status').value = '';
            document.getElementById('report-date-from').value = '';
            document.getElementById('report-date-to').value = '';
            document.getElementById('include-cost').checked = true;
            document.getElementById('include-sale').checked = true;
            document.getElementById('include-profit').checked = true;
            document.getElementById('include-competitors').checked = true;
            
            document.getElementById('report-results').innerHTML = 
                '<div class="no-results">Use the filters above to generate a report</div>';
        }

        function generateReport() {
            const companyId = document.getElementById('report-company').value;
            const status = document.getElementById('report-status').value;
            const dateFrom = document.getElementById('report-date-from').value;
            const dateTo = document.getElementById('report-date-to').value;
            
            const includeCost = document.getElementById('include-cost').checked;
            const includeSale = document.getElementById('include-sale').checked;
            const includeProfit = document.getElementById('include-profit').checked;
            const includeCompetitors = document.getElementById('include-competitors').checked;
            
            let filtered = [...products];
            
            if (companyId) {
                filtered = filtered.filter(p => p.company_id.toString() === companyId);
            }
            
            if (status) {
                filtered = filtered.filter(p => 
                    (status === 'active' && p.is_active) || 
                    (status === 'inactive' && !p.is_active)
                );
            }
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(p => new Date(p.created_at) >= fromDate);
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo + 'T23:59:59');
                filtered = filtered.filter(p => new Date(p.created_at) <= toDate);
            }
            
            // Generate report HTML
            let reportHTML = `
                <h3>Product Report</h3>
                <p>Generated on ${new Date().toLocaleString()}</p>
                <p>Total Products: ${filtered.length}</p>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Product Name</th>
                            <th>Company</th>
                            <th>Status</th>
            `;
            
            if (includeCost) reportHTML += '<th>Cost Price</th>';
            if (includeSale) reportHTML += '<th>Sale Price</th>';
            if (includeProfit) reportHTML += '<th>Profit</th><th>Margin</th>';
            if (includeCompetitors) reportHTML += '<th>Competitor Prices</th>';
            
            reportHTML += `</tr></thead><tbody>`;
            
            filtered.forEach(product => {
                const company = companies.find(c => c.id === product.company_id);
                const companyName = company ? company.name : 'Unknown';
                
                reportHTML += `
                    <tr>
                        <td>${product.id}</td>
                        <td>${escapeHtml(product.name)}</td>
                        <td>${escapeHtml(companyName)}</td>
                        <td class="${product.is_active ? 'active' : 'inactive'}">${product.is_active ? 'Active' : 'Inactive'}</td>
                `;
                
                if (includeCost) reportHTML += `<td>${formatCurrency(product.cost_price)} IQD</td>`;
                if (includeSale) reportHTML += `<td>${formatCurrency(product.sale_price)} IQD</td>`;
                if (includeProfit) {
                    reportHTML += `
                        <td>${formatCurrency(product.profit_amount)} IQD</td>
                        <td>${product.profit_margin.toFixed(2)}%</td>
                    `;
                }
                if (includeCompetitors) reportHTML += `<td>${escapeHtml(product.competitor_prices || '')}</td>`;
                
                reportHTML += `</tr>`;
            });
            
            reportHTML += `</tbody></table>`;
            
            document.getElementById('report-results').innerHTML = reportHTML;
        }
        
        function exportToPDF() {
            alert('PDF export functionality would be implemented here with a PDF library like jsPDF');
        }
        
        function exportToExcel() {
            alert('Excel export functionality would be implemented here with a library like SheetJS');
        }

        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName('tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }
            
            const tablinks = document.getElementsByClassName('tablinks');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(' active', '');
            }
            
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
<footer style="text-align:center; padding:20px; background-color:#f1f1f1; font-size:14px; color:#555;">
  &copy; System by Ammar Najah
</footer>
</html>